<!DOCTYPE html>
<html lang="ja">
<head>
  <style>
    #form-screen { display: none; }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Capsule — 未来の自分へ</title>
  <link rel="stylesheet" href="style.css">
</head>
  <body>
  <main>
    <!-- 扉画面（初期表示） -->
    <div id="door-screen" class="container" style="text-align:center;">
      <img src="https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80" alt="Time Capsule" style="width:180px; border-radius:12px; margin-bottom:16px;">
      <h1>Time Capsule</h1>
      <div style="margin-bottom:18px; color:#444; font-size:1.1rem;">
  今の思いを、未来の自分に刻みませんか？<br>
  少しの間、寝かせておきたい思い、ありませんか？<br>
  メッセージはBlockchain上に安全に保存し、あなたが指定した時期にお返します。<br>
　<br>
  使い方は自由です。<br>
　<br>
  ただ一つだけ。<br>
　<br>
  その時が来るまで、再びメッセージを見ることは出来ません。<br>
  <br>
  ・小さなこと、大きなこと。<br>
  ・Positiveなこと、Negativeなこと。<br>
  ・挑戦に集中する間は、大事に閉まっておきたい素敵な思い出<br>
  ・乗り越えるために忘れたい、でもいつかは向き合わないといけない出来事<br>
  ・未熟な罪と、伝わり切らなかった謝罪。再び向き合うべき宿命を感じる出来事<br>
  <br>あなたの心の支え、気づきにお役に立てますように。
      </div>
      <button id="startBtn" style="padding:10px 32px; font-size:1.1rem; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">はじめる</button>
    </div>
    <!-- 刻印画面（初期は非表示） -->
    <div id="form-screen" class="container">
      <div id="intro-message" style="margin-bottom: 16px; color: #555; font-size: 1rem;">
        このサービスは無料です。Blockchain（Polygon）の無料テストネット（Amoy）を使います。テスト用トークン（単位：POL）が必要ですが、取得方法もご案内します。安心してご利用ください。
      </div>
      <div id="info" style="margin-bottom:1em; color:#444; font-size:0.95em;">
        <strong>ご利用案内：</strong><br>
        <span style="color:#d32f2f;">【重要】PCのGoogle Chrome（またはChromium系）＋MetaMask拡張機能が必須です。<br>
        スマホやChrome以外のブラウザは非対応。PCのみ。<br>
        MetaMaskのChrome拡張機能を事前にインストールし、ログインしてからご利用ください。</span><br>
                <ul style="margin:0 0 0 1em; padding:0;">
          <li>最初に無料配布（Faucet、といいます）に申し込みPOLを獲得します。リンク（<a href="https://faucet.polygon.technology/" target="_blank">Polygon Faucet</a>）から獲得出来ます（当ツールで数十回利用に相当（1回で約0.1 POL消費））。</li>
          <li>残高が不足したら、再度Faucetして、POLを無料取得できます。</li>
        </ul>
        <span style="color:#888;">MetaMaskでAmoyネットワークを選択してご利用ください。</span>
      </div>
      <button id="connectBtn">MetaMask接続</button>
        <div id="metamask-guide" style="margin:8px 0 16px 0; color:#1976d2; font-size:0.98em;">
          MetaMaskの接続確認画面で『Vercel』と表示されますが、これは当サービスがVercel上で動作しているためです。<br>
          安心して、接続や確認を選んでください。
        </div>
      <form id="capsuleForm">
        <label for="email">メールアドレス</label>
        <input type="email" id="email" required>
        <label for="plaintext">今日のあなたから、未来のあなたへ</label>
        <textarea id="plaintext" rows="4" maxlength="500" required></textarea>
        <label for="months">開封までの期間（月・日・分）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="number" id="months" min="0" max="24" value="0" required style="width:80px;">か月
            <input type="number" id="days" min="0" max="30" value="0" required style="width:80px;">日
            <input type="number" id="minutes" min="0" max="1440" value="1" required style="width:80px;">分
          </div>
          <div style="color:#888; font-size:0.95em; margin-bottom:8px;">開封までの期間は「0～24か月、0～30日、0～1440分」の整数で自由に指定できます。合計1分以上であればOKです。テストネットは長期保存保証がありません。2年以内を推奨します。</div>
        <label for="password">暗号化パスワード</label>
        <input type="password" id="password" minlength="4" maxlength="32" required placeholder="パスワード（4文字以上）">
        <div style="color:#d32f2f; font-size:0.95em; margin-bottom:8px;">※パスワードは復元時に必須です。紛失しないよう安全に保管してください（英数字・記号、4～32文字）。</div>
            <button type="submit" id="submitBtn">ブロックチェーンに刻む</button>

        <hr>
        <h2>カプセル復号フォーム</h2>
  <div id="metamaskStatus" style="margin-bottom:12px; color:#1976d2; font-weight:bold;"></div>
        <!--
        <div style="color:#1976d2; font-size:0.98em; margin-bottom:8px;">
          <strong>※通常は指定日時に届くメールから復号してください。</strong><br>
          万が一メールが届かない場合は、こちらで手動復号できます。<br>
          メール記載のID・暗号化メッセージ・パスワードを入力してください。
        </div>
        <div id="decryptSection">
          <label for="decryptCapsuleId">カプセルID:</label>
          <input type="text" id="decryptCapsuleId" placeholder="メール記載のID" />
          <br>
          <label for="decryptEncryptedMsg">暗号化メッセージ:</label>
          <textarea id="decryptEncryptedMsg" rows="3" placeholder="メール記載の暗号化文字列"></textarea>
          <br>
          <label for="decryptPassword">パスワード:</label>
          <input type="password" id="decryptPassword" placeholder="保存時のパスワード" />
          <br>
          <button id="decryptBtn" type="button">復号する</button>
          <div id="decryptResult" style="margin-top:10px;color:green;"></div>
        </div>
        -->
    <div id="capsuleIdNotice" style="margin-top:12px; color:#1976d2; font-weight:bold;"></div>
      </form>
      <div id="status"></div>
      <div id="result-message" style="margin-top: 16px; color: #1976d2; font-weight: bold;"></div>
      <div id="completion-message" style="margin-top: 16px; color: #333; font-size: 1.1rem; display: none;"></div>
  <div id="txLink" style="margin-top:8px;"></div>
      <hr style="margin:24px 0;">
      <div style="margin-bottom:8px; color:#555; font-size:1em;">カプセルを開封する</div>
      <div style="color:#1976d2; font-size:0.98em; margin-bottom:8px;">
        <strong>※指定日時に届くメールから、カプセルIDとパスワードで復号できます。逆に言えば、その時まで開くことが出来ません。</strong><br>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; max-width:340px;">
        <label for="capsuleId">カプセルID</label>
        <input type="number" id="capsuleId" min="0" placeholder="例: 0">
        <label for="unlockPassword">パスワード（暗号化時と同じ）</label>
        <input type="password" id="unlockPassword" minlength="4" maxlength="32" placeholder="パスワード">
        <button id="getBtn" type="button">カプセル取得・開封</button>
        <div id="getResult" style="margin-top:12px; color:#1976d2; font-weight:bold;"></div>
      </div>
    </div>
  </main>
  <script>
    // SPA画面切り替え
    document.getElementById('form-screen').style.display = 'none';
    document.getElementById('startBtn').onclick = function() {
      document.getElementById('door-screen').style.display = 'none';
      document.getElementById('form-screen').style.display = 'block';
    };
    // 完了時のメッセージ表示処理
    function showCompletionMessage() {
      const msg = document.getElementById('completion-message');
      msg.innerHTML = `\uD83C\uDF89 お疲れさまでした！<br>あなたのメッセージは未来の自分へ安全に保存されました。<br>メールもご確認ください。<br>POLが足りなくなった場合は、再度取得できます。`;
      msg.style.display = 'block';
    }
    window.showCompletionMessage = showCompletionMessage;
  </script>
<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="main.js"></script>
<!-- CryptoJS AES 暗号化用CDN -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
</body>
</html>
